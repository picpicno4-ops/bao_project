<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Sans+TC:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <!-- Air Datepicker -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.css"
    />
    <link rel="stylesheet" href="../assets/scss/all.scss" />
    <title>設定目標日期</title>
  </head>
  <body class="bg-primary-500">
    <main class="py-4 d-flex justify-content-center bg-primary-500">
      <!-- 手機框定位點 -->
      <div
        class="position-relative d-flex justify-content-center align-items-center w-420 h-850 overflow-hidden"
      >
        <!-- 手機框圖片 -->
        <img
          class="position-absolute z-3000 w-100 h-100 pointer-events-none w-300"
          src="../assets/images/iphone13 mockup.svg"
          alt=""
        />

        <section class="cell-phone-y bg-surface-bg z-0">
          <%- include('./layout/header'); -%>

          <div class="page-swiper">
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <div class="d-flex flex-column custom-height">
                  <div
                    class="py-2 ps-3 pe-30 d-flex align-items-center mt-3 z-0"
                  >
                    <a href="target_info.html" class="btn p-2 border-0"
                      ><img
                        src="/assets/images/left_line.svg"
                        alt="回上一頁"
                        class="d-block"
                    /></a>
                    <h1
                      class="fs-6 fw-bold lh-1 mb-0 flex-grow-1 text-center text-neutral-800"
                    >
                      規律飲食
                    </h1>
                  </div>

                  <!-- 選擇日期 -->
                  <p class="text-primary-950 lh-38 ms-10 mb-4">
                    就今天開始吧～
                  </p>

                  <div class="position-relative mb-4">
                    <div class="target-deco">
                      <img
                        src="/assets/images/eattingrice mirror.svg"
                        alt="eattingrice"
                      />
                    </div>
                    <div class="bg-white p-3 border-radius-12 mx-4">
                      <p class="text-primary-800 fs-8 fw-medium lh-base mb-4">
                        輸入日期
                      </p>
                      <div
                        class="d-flex justify-content-between align-items-center"
                      >
                        <p
                          id="selectedDateText"
                          class="text-primary-950 fs-32 mb-0"
                        >
                          7月17日(一)
                        </p>
                        <button
                          type="button"
                          class="btn p-0 border-0 text-primary-600"
                          data-bs-toggle="collapse"
                          data-bs-target="#calendarCollapse"
                          role="button"
                          aria-expanded="false"
                          aria-controls="calendarCollapse"
                        >
                          <img
                            src="/assets/images/calendar_line.svg"
                            alt="calendar_line"
                          />
                        </button>
                      </div>

                      <div class="collapse" id="calendarCollapse">
                        <div class="pt-4 pb-3 border-top border-primary mt-4">
                          <div id="airDatepicker"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 下一步按鈕 -->
                  <div class="mx-3 mt-auto mb-28">
                    <a
                      href="target_time.html"
                      class="btn btn-primary-300 text-primary-950 fw-bold lh-sm py-3 rounded-pill w-100"
                      >下一步</a
                    >
                  </div>
                </div>
              </div>
              <div class="swiper-slide h-12" id="spacerSlide"></div>
            </div>
          </div>

          <!-- 導覽列區塊 -->
          <%- include('./layout/footer_personal'); -%>
        </section>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.js"></script>
    <script>
      // 頁面滾動設定
      const pageSwiper = new Swiper(".page-swiper", {
        direction: "vertical",
        slidesPerView: "auto",
        mousewheel: true,
        autoHeight: true,
        resistanceRatio: 0,
      });

      // collapse 未開啟時，手機不滑動
      const spacerSlide = document.getElementById("spacerSlide");
      const collapseEl = document.getElementById("calendarCollapse");

      function applySpacerVisibility() {
        const isOpen = collapseEl.classList.contains("show");
        spacerSlide.classList.toggle("d-none", !isOpen);

        // 讓 Swiper 重新計算
        pageSwiper.updateSlides(); // 重新掃描可見 slides
        pageSwiper.update(); // 重算尺寸/位置
        pageSwiper.updateAutoHeight(200); // 依 active slide 調整容器高度（有開 autoHeight）
      }
      applySpacerVisibility();

      // 監聽 Bootstrap collapse 事件
      collapseEl.addEventListener("shown.bs.collapse", applySpacerVisibility);
      collapseEl.addEventListener("hidden.bs.collapse", applySpacerVisibility);

      // Air Datepicker 月曆
      // 語系資料
      const zh = {
        days: [
          "星期日",
          "星期一",
          "星期二",
          "星期三",
          "星期四",
          "星期五",
          "星期六",
        ],
        daysShort: ["週日", "週一", "週二", "週三", "週四", "週五", "週六"],
        daysMin: ["日", "一", "二", "三", "四", "五", "六"],
        months: [
          "一月",
          "二月",
          "三月",
          "四月",
          "五月",
          "六月",
          "七月",
          "八月",
          "九月",
          "十月",
          "十一月",
          "十二月",
        ],
        monthsShort: [
          "1月",
          "2月",
          "3月",
          "4月",
          "5月",
          "6月",
          "7月",
          "8月",
          "9月",
          "10月",
          "11月",
          "12月",
        ],
        today: "今天",
        clear: "清除",
        format: "yyyy/mm/dd",
        timeFormat: "hh:mm aa",
        firstDay: 0,
      };

      // 工具：把 Date 轉成「7月17日(一)」
      function formatForHeading(date) {
        const days = ["日", "一", "二", "三", "四", "五", "六"];
        const m = date.getMonth() + 1;
        const d = date.getDate();
        const w = days[date.getDay()];
        return `${m}月${d}日(${w})`;
      }

      // 設定停用日期
      // const disabledDate = ["2025-08-01", "2025-08-05"];

      const selectedDateTextEl = document.getElementById("selectedDateText");
      // 預設選取今天
      const today = new Date();
      // 一進頁就把標題改成今天
      selectedDateTextEl.textContent = formatForHeading(today);

      // 加入月曆
      const dp = new AirDatepicker("#airDatepicker", {
        inline: true,
        locale: zh,
        // 預設選取的日期
        selectedDates: [today],
        navTitles: {
          days: `
                    <div class="custom-nav-title">
                    <span class="nav-year">yyyy 年</span>
                    <span class="nav-month">M 月</span>
                    </div>
                `,
        },
        showOtherMonths: false,
        // 每次選取時更新文字
        onSelect({ date }) {
          if (date) {
            selectedDateTextEl.textContent = formatForHeading(date);
          }
        },
      });
      dp.disableDate(disabledDate);

      // 一開始就把預設選到的日期顯示出來
      // 如果你有用 selectedDates，上面會是今天
      const initial = dp.selectedDates?.[0] || today;
      selectedDateTextEl.textContent = formatForHeading(initial);
    </script>
    <script type="module" src="../main.js"></script>
    <script src="../change_page.js"></script>
  </body>
</html>
